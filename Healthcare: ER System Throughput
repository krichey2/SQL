--ER Throughput: ER throughput is a key indicator of volume, patient access,
and systemâ€™s ability to support its community

--How many emergency encounters did we have in 2019?

SELECT COUNT(*) AS ER_VOLUMES
FROM HEALTHCARE.ENCOUNTERS
WHERE START >='2019-01-01'
AND START <'2020-01-01'
AND ENCOUNTERCLASS = 'emergency'
;

--125


--What conditions were treated in those encounters?

SELECT CON.DESCRIPTION
,COUNT(*)AS CONDITION_VOLUMES
FROM HEALTHCARE.ENCOUNTERS ENC
JOIN HEALTHCARE.CONDITIONS CON ON ENC.ID=CON.ENCOUNTER
WHERE ENC.START >='2019-01-01'
AND ENC.START <'2020-01-01'
AND ENC.ENCOUNTERCLASS = 'emergency'
GROUP BY CON.DESCRIPTION
;

--23 conditions treated

SELECT CON.DESCRIPTION
,COUNT(*)AS CONDITION_VOLUMES
FROM HEALTHCARE.ENCOUNTERS ENC
LEFT JOIN HEALTHCARE.CONDITIONS CON ON ENC.ID=CON.ENCOUNTER
WHERE ENC.START >='2019-01-01'
AND ENC.START <'2020-01-01'
AND ENC.ENCOUNTERCLASS = 'emergency'
GROUP BY CON.DESCRIPTION
;

--56 NULL entries (no description provided)

SELECT *
FROM HEALTHCARE.ENCOUNTERS ENC
JOIN HEALTHCARE.CONDITIONS CON ON ENC.ID=CON.ENCOUNTER
WHERE ENC.START >='2019-01-01'
AND ENC.START <'2020-01-01'
AND ENC.ENCOUNTERCLASS = 'emergency'
;



--What was the emergency throughput and how did that vary
by condition treated?

SELECT 
THROUGHPUT.DESCRIPTION
,AVG(THROUGHPUT_IN_MIN) AS THR_AVG
FROM(
		SELECT ENC.ID
        ,CON.DESCRIPTION
        ,TIMESTAMPDIFF(MINUTE, ENC.START, ENC.STOP) THROUGHPUT_IN_MIN
		FROM HEALTHCARE.ENCOUNTERS ENC
        LEFT JOIN HEALTHCARE.CONDITIONS CON ON ENC.ID=CON.ENCOUNTER
		WHERE ENC.START >='2019-01-01'
		AND ENC.START <'2020-01-01'
		AND ENC.ENCOUNTERCLASS = 'emergency'
) THROUGHPUT
GROUP BY THROUGHPUT.DESCRIPTION
;

--How many emergency encounters did we have before 2020?

SELECT COUNT(*) AS ER_VOLUMES
FROM HEALTHCARE.ENCOUNTERS
WHERE START <='2020-01-01'
AND ENCOUNTERCLASS = 'emergency'
;
--2051

--Other than nulls (where no condition was documented), which condition was most documented for emergency encounters before 2020?

SELECT CON.DESCRIPTION
,COUNT(*)AS CONDITION_VOLUMES
FROM HEALTHCARE.ENCOUNTERS ENC
LEFT JOIN HEALTHCARE.CONDITIONS CON ON ENC.ID=CON.ENCOUNTER
WHERE ENC.START <='2020-01-01'
AND ENC.ENCOUNTERCLASS = 'emergency'
GROUP BY CON.DESCRIPTION
;
-- sprained ankle

--How many conditions for emergency encounters before 2020 had average ER throughputs above 100 minutes? Don't count nulls if they appear in your solution.

SELECT 
THROUGHPUT.DESCRIPTION
,AVG(THROUGHPUT_IN_MIN) AS THR_AVG
FROM(
		SELECT ENC.ID
        ,CON.DESCRIPTION
        ,TIMESTAMPDIFF(MINUTE, ENC.START, ENC.STOP) THROUGHPUT_IN_MIN
		FROM HEALTHCARE.ENCOUNTERS ENC
        LEFT JOIN HEALTHCARE.CONDITIONS CON ON ENC.ID=CON.ENCOUNTER
		WHERE ENC.START <='2020-01-01'
		AND ENC.ENCOUNTERCLASS = 'emergency'
) THROUGHPUT
GROUP BY THROUGHPUT.DESCRIPTION
;
--17; fracture of forearm, fracture of clavicle, acute allergic reaction, history of cardiac arrest, cardiac arrest, fracture of ankle, fracture of rib, myocardial infarction, closed fracture of hip, osteoporosis
